!!! 5

html
 include head
 body
  include jumbo

  .promote
   .container
      h2 Toutes les annonces
      p Risno recherche sur les principaux sites d'annonces immobilières mais aussi sur les sites des principales enseignes d'agences et même peut-être celui de la petite agence près de chez vous.
        if stats
          span En ce moment, risno référence&nbsp;:
      if stats
        ul
          each stat in stats
            li
              span= stat.nb 
              span  annonces du site 
              a(href="http://" + stat.host) 
                = stat.host
              span  mises à jour 
              span= moment(stat.older, '', 'fr').fromNow()


      h2 Classez vos annonces
      p Une annonce vous plaît ? Mettez là de coté dans les 
       span.label.label-success biens
      p Encore une annonce pas terrible ? Oubliez la dans les 
       span.label.label-danger bofs 

  .promote
   .container.help
     .col-lg-6.col-md-6.box
      h2 Nouveau venu
      p Votre compte Risno est déjà prêt. Votre identifiant est 
       span.label.label-primary= user_code
      p Conservez-le précieusement, il vous permettra de retrouver vos annonces et vos filtres à chaque visite.
      p
       button.btn.btn-primary(data-toggle="modal",data-target="#send_new_id") Consulter les annonces

     .col-lg-6.col-md-6.box
      h2 Déjà venu
      p Vous avez déjà reçu un identifiant qui vous permet de retrouver vos annonces et vos filtres.
      p
       button.btn.btn-success(data-toggle="modal",data-target="#enter_id") Ah oui, je m'en souviens !
       button.btn.btn-danger(data-toggle="modal",data-target='#send_id') Ah... ben j'ai oublié :(

  .modal.fade(id="send_new_id",role="dialog")
   .modal-dialog
    .modal-content
     .modal-header
      button.close(type="button",data-dismiss="modal") &times;
      h4.modal-title Recevez votre identifiant par email : 
       span.label.label-primary= user_code
     .modal-body
      form(method="POST",action="/send_new_id",id="send_new_id_form",role="form")
       input(type="hidden",name="user_code",value=user_code)
       .form-group
        label.control-label.sr-only(for="email") Votre email
        input.form-control(id="email",name="email",type="email",required,placeholder="Votre email")
       .form-group
        label.control-label.sr-only(for="confirm_email") Confirmez votre email
        .controls
         input.form-control(name="confirm_email",type="email",placeholder="Confirmez votre email")
       .form-group
        button.btn.btn-success.pull-right(type=submit) Envoyer
     .modal-footer
      .pull-left
       p(style="text-align: left;") Attention ! si vous choisissez de ne pas recevoir votre identifiant par email, nous ne pourrions rien pour vous si jamais vous le perdiez.
      .form-group
       a.button.btn.btn-danger(href='/_/' + user_code + '/criteria') Je prend le risque

  .modal.fade(id="enter_id",role="dialog")
   .modal-dialog
    .modal-content
     form(id="enter_id_form",role="form")
      .modal-header
       button.close(type="button",data-dismiss="modal") &times;
       h4.modal-title Retrouvez vos critères et vos annonces
      .modal-body
       .form-group
        label.control-label.sr-only(for="user_code") Votre identifiant Risno
        input.form-control(name="user_code",type="text",required,placeholder="Votre identifiant Risno")
      .modal-footer
       .form-group
        button.btn.btn-primary(type=submit) Voir mes annonces

  .modal.fade(id="send_id",role="dialog")
   .modal-dialog
    .modal-content
     form(id="send_id_form",role="form")
      .modal-header
       button.close(type="button",data-dismiss="modal") &times;
       h4.modal-title Recevoir votre identifiant par email 
      .modal-body
       .form-group
        label.control-label.sr-only(for="email") Votre email
        input.form-control(name="email",type="email",required,placeholder="Votre email")
       .form-group
      .modal-footer
       .form-group
        button.btn.btn-primary(id="send_id_button",type="button",data-loading-text="Envoi...") Envoyer
       .alert.alert-success(style="display: none;") Un email avec vos identifiants vous a été envoyé.
       .alert.alert-danger(style="display: none;") Désolé, l'envoi vers cette adresse a échoué.
  include foot

  script.
    $('#send_id_button').button('reset')
    $('#send_id_button').click(function() {
      var btn = $(this)
      var form = btn.parents('form')
      if (! form.valid()) return
      var input = form.find('input[name=email]')
      var email = input.val()
      var success_msg = btn.closest('.modal-footer').find('.alert-success')
      var error_msg = btn.closest('.modal-footer').find('.alert-danger')
      success_msg.hide()
      error_msg.hide()
      btn.button('loading')
      $.ajax("/send_id", {
        data: {email: email},
        type: 'POST'
      }).done(function() {
        success_msg.show()
      }).fail(function() {
        error_msg.show()
      }).always(function() {
        btn.button('reset')
      })
    })
  
  script(src="/jquery/jquery.validate.js")

  script.
   $(document).ready(function() {
    var highlight = function(element) {
      $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
    }
    var success = function(element) {
      element.closest('.form-group').removeClass('has-error').addClass('has-success')
    }
    var errorPlacement = function(error, element) {
       error.addClass("control-label")
       error.insertBefore(element)
    }
 
    $('#enter_id_form').validate({
     messages: {
       user_code: "Veuillez indiquer votre identifiant Risno :"
     },
     errorPlacement: errorPlacement,
     highlight: highlight,
     success: success
    })
    $('#send_id_form').validate({
     rules: {
       email: {
         remote: '/check_mail'
       }
     },
     messages: {
       email: "Veuillez indiquer un email valide :",
     },
     errorPlacement: errorPlacement,
     highlight: highlight,
     success: success
    })
    $('#send_new_id_form').validate({
     rules: {
      confirm_email: {
       equalTo: "#email"
      }
     },
     messages: {
       email: "Veuillez indiquer un email valide :",
       confirm_email: "Veuillez confirmer votre email :"
     },
     errorPlacement: errorPlacement,
     highlight: highlight,
     success: success
    })
   })
